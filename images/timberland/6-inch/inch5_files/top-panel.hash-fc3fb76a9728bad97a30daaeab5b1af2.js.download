define(["jquery","domReady","wcs.mini-list","wcs.context","shared.main.screen","promise!wcs.lang-msg","pubsub","foundation.util.keyboard"],function(r,i,l,c,n){var t=window.ACTION_URLS&&window.ACTION_URLS.MINI_SHOPPING_URL?window.ACTION_URLS.MINI_SHOPPING_URL:"",u=Boolean(window.localStorage.getItem("DEBUG"))||!1;return(new function(){var s=this;this.disableMiniCart=!!r("body").data("disableMiniCart")&&r("body").data("disableMiniCart"),this.$topMiniCart=r(".topnav-minicart-panel, .global-cart-wishlist-panels-top-js"),this.$toggle=r(".topnav-cart, .unav-shoppingbag-js"),this.$topNavCart=r(".topnav-utility .topnav-cart a"),this.$cartLink=this.$toggle.find("a"),this.isOpen=!1,this.autoHide=!1,this.insideMiniCart=!1,this.autoHideTimeOut=parseInt(WCS_CONFIG.get("global::miniCartAutoHideTime")),this.mouseOutTime=250,this.cartMinHeight=parseInt(WCS_CONFIG.get("global::miniCartMinHeight")),this.timerQueue=[],this.wasOpened=!1,this.cartContentsURL=t,this.repositionMiniCartWhenOpening=WCS_CONFIG.get("global::repositionMiniCartWhenOpening"),this._clearAllTimers=function(){s.timerQueue.forEach(function(i){clearTimeout(i)})},this._addTimer=function(i){s.timerQueue.push(i)},this._replaceTimers=function(i){s._clearAllTimers(),s._addTimer(i)},this.closeMiniCart=function(){return s._clearAllTimers(),s._hideTopMiniCart()},this.isStickyNavEnabled=function(){if(0<r("header.sticky-minimized").length)return!0;var i=r(".header-container");return 0<i.has(".fixed-medium").length&&"small"!==n.size()||0<i.has(".fixed-small").length&&"small"===n.size()},this.openMiniCart=function(i){u&&console.log("top-panels.js","openMiniCart",i);var t=(i=i||{}).autoHideTimeOut||s.autoHideTimeOut,e=!s.wasOpened;return s.wasOpened=!0,s._clearAllTimers(),s._showTopMiniCart().then(function(){return s.populateTopMiniCart(e).then(function(){if(i.autoHide&&s._replaceTimers(setTimeout(function(){s.closeMiniCart()},t)),s.isStickyNavEnabled()||s.disableMiniCart||r(window).scrollTop(0),i.openOnHover)try{window.dataLayer.push({event:"miniCartView",location:"top-panel"})}catch(i){console.error("Failed push to dataLayer",i)}})})},this.getTopMiniCartType=function(){return 0<r(".topnav-cart").length?"cms":"ecom"},this.positionTopMiniCart=function(){var i,t=0;if("small"!==n.size()&&this.repositionMiniCartWhenOpening){if(0<this.$topNavCart.length){var e=this.$topNavCart[0].getBoundingClientRect();i=e.height+e.top}"ecom"===s.getTopMiniCartType()&&(t=10+(r(window).width()-r(".master-header").innerWidth())/2),s.$topMiniCart.css({right:t,top:i,minHeight:s.cartMinHeight})}else s.$topMiniCart.css({right:"",top:"",minHeight:""})},this.populateTopMiniCart=function(i,t,e){u&&console.log("top-panels.js","populateTopMiniCart"),i=i||!1;var n=s.$topMiniCart,o={storeId:c.getStoreId(),langId:c.getLangId(),catalogId:c.getCatalogId()},a={title:LANG_MSG["DEAFULT_MINICART.SHOPPING.title"],page:"shopcart",container:n.find(".shopcart.cart-list"),isInit:i};return 0===r(".cart-item-slide-js").find(".cart-item-js").length||"SHOPCART_UPDATED"===e?l.renderMiniListItems(s.cartContentsURL,o,a,t):(l.initCarousel(a),r.Deferred().resolve().promise())},this._showTopMiniCart=function(){u&&console.log("top-panels.js","_showTopMiniCart");var i=new r.Deferred;if(s.isOpen=!0,s.positionTopMiniCart(),s.$toggle.addClass("active active-js"),s.$topMiniCart.removeClass("hide").addClass("fade-in"),"small"!==n.size()){var t=s.$topMiniCart.find(".notification");r(".minicart-sr-text-js").insertBefore(t)}return setTimeout(function(){s.$topMiniCart.removeClass("fade-in").find(".cart-js").addClass("active-js"),i.resolve()},s.mouseOutTime),i.promise()},this._hideTopMiniCart=function(){u&&console.log("top-panels.js","_hideTopMiniCart");var i=new r.Deferred;return s.isOpen=!1,s.$toggle.removeClass("active active-js").siblings().removeClass("inactive inactive-js"),s.$topMiniCart.addClass("fade-out").find(".cart-js").removeClass("active-js"),setTimeout(function(){s.$topMiniCart.addClass("hide").removeClass("fade-out").find(".notification").addClass("hide"),"small"!==n.size()&&r(".minicart-sr-text-js").remove(),i.resolve()},s.mouseOutTime),i.promise()},this.shopcartUpdateAction=function(i,t){u&&console.log("top-panels.js","shopcartUpdateAction",i,t);var e="delete"!==t.action;"small"!==n.size()&&t?s.populateTopMiniCart(!1,t,"SHOPCART_UPDATED").done(function(){return s.openMiniCart({autoHide:e})}).done(function(){if(s.insideMiniCart){var i=Foundation.Keyboard.findFocusable(s.$topMiniCart);i&&(i.first().focus(),Foundation.Keyboard.trapFocus(s.$topMiniCart))}}):s.openMiniCart()},this._utilityNavMouseOverHandler=function(){return u&&console.log("top-panels.js","_utilityNavMouseOverHandler"),!!s.$toggle.hasClass("has-products")&&(!(0<=r.inArray(n.size(),["small","medium"]))&&(r.pubsub("publish","vfdp.toppanel.OPEN_MINI_CART"),void s.openMiniCart({autoHide:!0,openOnHover:!0})))},this._minicartInteractionEvents=function(i){u&&console.log("top-panels.js","_minicartInteractionEvents"),i.on({touchstart:function(i){u&&console.log("top-panels.js","_utilityNavMouseOverHandler","touchstart"),s.isOpen&&s._clearAllTimers()},mouseenter:function(i){u&&console.log("top-panels.js","_utilityNavMouseOverHandler","mouseenter"),s._clearAllTimers()},mouseleave:function(i){u&&console.log("top-panels.js","_utilityNavMouseOverHandler","mouseleave"),s.isOpen&&s._replaceTimers(setTimeout(function(){s.closeMiniCart()},s.autoHideTimeOut))}})},this._linkInteractionEvents=function(i){u&&console.log("top-panels.js","_linkInteractionEvents"),i.on({mouseenter:function(i){u&&console.log("top-panels.js","_linkInteractionEvents","mouseenter"),s._utilityNavMouseOverHandler()},mouseleave:function(i){u&&console.log("top-panels.js","_linkInteractionEvents","mouseleave"),s._replaceTimers(setTimeout(function(){s.closeMiniCart()},s.mouseOutTime))}})},this.cartLinkHasFocus=function(){return this.$cartLink.is(":focus")},this.events=function(){r.pubsub("subscribe","EMAIL_ME_MY_CART_ACTION",function(){s._clearAllTimers()}),r.pubsub("subscribe","EMAIL_ME_MY_CART_FINISHED",function(){s._replaceTimers(setTimeout(s.closeMiniCart,s.autoHideTimeOut))}),r(s.$topMiniCart).on("click",".mini-cart-icon-close-js",function(i){s.closeMiniCart()}),r(document).on("click touchstart",function(i){r(i.target).closest(s.$topMiniCart).length<=0&&s.closeMiniCart()}),r(document).on("open.zf.reveal",function(){s.closeMiniCart()}),r.pubsub("subscribe","vfdp.wcs.free_gift.offer_complete",function(){s.openMiniCart({autoHide:!0})}),r.pubsub("subscribe","SHOPCART_UPDATED",s.shopcartUpdateAction.bind(s)),s._linkInteractionEvents(s.$toggle),s._minicartInteractionEvents(s.$topMiniCart),Foundation.Keyboard.register("miniCart",{SPACE:"enterMiniCart",ESCAPE:"exitMiniCart",ENTER:"followMiniCartLink"}),r(document).on("keydown.top-panel.minicart",function(i){Foundation.Keyboard.handleKey(i,"miniCart",{enterMiniCart:function(){u&&console.log("top-panels.js","keydown.top-panel.minicart","enterMiniCart"),s.cartLinkHasFocus()&&s.$toggle.hasClass("has-products")&&(i.preventDefault(),r.pubsub("publish","vfdp.toppanel.OPEN_MINI_CART"),s.openMiniCart({autoHide:!1,openOnHover:!0}).done(function(){if(!s.insideMiniCart){s.insideMiniCart=!0;var i=Foundation.Keyboard.findFocusable(s.$topMiniCart);i&&(i.first().focus(),Foundation.Keyboard.trapFocus(s.$topMiniCart))}}))},exitMiniCart:function(){u&&console.log("top-panels.js","keydown.top-panel.minicart","exitMiniCart"),s.insideMiniCart&&(Foundation.Keyboard.releaseFocus(s.$topMiniCart),s.$cartLink.focus(),s.closeMiniCart(),s.insideMiniCart=!1)},followMiniCartLink:function(){u&&console.log("top-panels.js","keydown.top-panel.minicart","followMiniCartLink"),s.cartLinkHasFocus()&&s.$cartLink.trigger("click")}})})},this.init=function(){return s.positionTopMiniCart(),0===r("body#checkout").length&&s.events(),this}}).init()});
//# sourceMappingURL=../../../maps/js/wcs/view/top-panel.hash-d8fe7c7df00d2d5e6e1f0b8cf684430e.js.map