define(["jquery","Handlebars","handlebars-core","pubsub"],function(m,e,t,i){function n(e,t){this.element=e,this.options=t}var a="powerReviews";n.defaults=(n.prototype={defaults:{template:"html.power-reviews.star-ratings.base",id:"powerReviewsServiceOptionPrPageId",plpIdAttribute:"prProductid",productClass:".product-block",targetClass:".product-block-rating",iconClass:".icon-star",iconContainerClass:".star-rating-icon-container",topStarRatings:".star-rating-star.top",componentClass:".star-rating-component",powerReviewsClass:".power-reviews-service-js",writeFirstReviewSelector:".product-content-info-write-review-link",powerReviewsConfig:"powerReviewsServiceOptions",apiBaseURL:"https://readservices-b2c.powerreviews.com",maxResults:10,totalStars:5,defaultRating:0,defaultReviews:0,starRatingAriaLabelTemplateID:"#star-rating-template-aria-label",starRatingReviewsTemplateID:"#star-rating-template-reviews",sizeAndFitReviewsTemplateID:"#pdp-size-and-fit-template-reviews",customerRecommendedTemplateID:"#pdp-customer-recommended-template",hiddenClass:"hide",eventDelay:2e3,endpoint:"snippet",endpointService:"PLP-Ratings",endpointServices:{plpRatings:"PLP-Ratings",sizeFit:"Size-Fit-Reviews",pdpRatings:"PDP-Ratings",pdpReviews:"PDP-Reviews",pdpReco:"PDP-Recommendations"},bypassConfig:!0,bypassConfigParam:"_noconfig=true",waitForPubSub:!1,prSnippetID:"#pr-size-fit-snippet",customerRecommendedShowThreshold:.5,useParenthesisOnProductCounter:!1},init:function(){var e=this;e.metadata=m(e.element).data(a+"Options"),e.config=m.extend({},e.defaults,e.options,e.metadata),e.config.products=[],e.config.productids=[],e.config.noRatings=[],e.config.ratings={},e.config.imagesLoadedTriggered=!1;var t=m(e.config.targetClass);return 0<t.length&&t.data("useParenthesisOnProductCounter")&&(e.config.useParenthesisOnProductCounter=t.data("useParenthesisOnProductCounter")),e.getPowerReviewsConfig(),e},events:function(){var i=this;i.productsLoadedEvent=m.pubsub("subscribe","vfdp.wcs.product_list.ajax_product_loaded",function(e,t){i.config.imagesLoadedTriggered||(clearTimeout(i.eventTimer),i.getProductIDs())}),i.loadMoreResultsEvent=m.pubsub("subscribe","vfdp.wcs.product_list.LOAD-MORE-RESULTS",function(e,t){0}),i.imagesLoadedEvent=m.pubsub("subscribe","vfdp.wcs.product_list.IMAGES_LOADED",function(e,t){i.config.imagesLoadedTriggered=!0,clearTimeout(i.eventTimer),i.getProductIDs()})},subscribeSwatchEvents:function(){var i=this;m.pubsub("subscribe","product-form.attr.swatch.click",function(e,t){i.currentSwatch=m(t.target).parent(),i.config.buildComplete=!1,!i.config.pdpPowerReviewFitScaleEnabled&&i.config.isModelMeasurementInFitScale&&i.populateSizeFit()}),m.pubsub("subscribe","vfdp.wcs.product_sizefit.refreshed",function(){setTimeout(function(){i.populateSizeFit()},i.config.eventDelay)})},_build:function(t){var i=this;i.loadAndCompileTemplate().done(function(e){i.render(t)}).fail(function(){i.unsubscribeEvents.bind(i)})},render:function(e){var t=this;if(!t.config.data||!t.config.data.results||t.config.data.results.length){t.config.ratings=e.data("ratings")?e.data("ratings"):t.config.data.results[0].rollup,t.config.ratings.average_rating||(t.config.ratings.average_rating=0);var i=e.find(t.config.writeFirstReviewSelector);if(t.config.ratings.review_count?i.addClass(t.config.hiddenClass):i.removeClass(t.config.hiddenClass),0!==t.config.ratings.average_rating||!1!==WCS_CONFIG.get("grid::displayNotRatedImage"))if(t.getTemplateData(),t.template=t.compiledTemplate(t.config.templateData),(t.config.endpointService===t.config.endpointServices.plpRatings||t.config.endpointService===t.config.endpointServices.pdpRatings)&&e.find(t.config.componentClass).length<=0)e.find(t.config.targetClass).append(t.template),e.find(t.config.topStarRatings).removeClass(t.config.hiddenClass),t.setClipPath(e,t.config.ratings.average_rating);else(0<m(t.element).find(e).length?m(t.element).find(e):m(t.config.componentClass).find(t.config.targetClass)).html(t.template)}},getTemplateData:function(){var e=this;switch(e.config.endpointService){case e.config.endpointServices.plpRatings:e.config.starRatingAriaLabelTemplate=e.getTemplateString(e.config.starRatingAriaLabelTemplateID),e.config.starRatingReviewsTemplate=e.getTemplateString(e.config.starRatingReviewsTemplateID),e.config.templateData={starRatingAriaLabel:e.compileTemplateStringRatings(e.config.starRatingAriaLabelTemplate,e.config.ratings),starRatingReviews:e.compileTemplateStringReviews(e.config.starRatingReviewsTemplate,e.config.ratings),rating:e.config.ratings.average_rating,ratingMax:e.config.totalStars,useParenthesisOnProductCounter:e.config.useParenthesisOnProductCounter};break;case e.config.endpointServices.sizeFit:e.currentSwatch=m(".color-swatches-js").find("button.selected"),e.config.sizeAndFitReviewsTemplate=e.getTemplateString(e.config.sizeAndFitReviewsTemplateID),e.config.templateData={sizeAndFitReviews:e.compileTemplateStringReviews(e.config.sizeAndFitReviewsTemplate,e.config.ratings)};break;case e.config.endpointServices.pdpReco:e.config.customerRecommendedTemplate=e.getTemplateString(e.config.customerRecommendedTemplateID),e.config.templateData={customerRecommended:e.compileTemplateStringCustomerRecommended(e.config.customerRecommendedTemplate,e.config.ratings)};break;default:e.config.starRatingAriaLabelTemplate=e.getTemplateString(e.config.starRatingAriaLabelTemplateID),e.config.starRatingReviewsTemplate=e.getTemplateString(e.config.starRatingReviewsTemplateID),e.config.templateData={starRatingAriaLabel:e.compileTemplateStringRatings(e.config.starRatingAriaLabelTemplate,e.config.ratings),starRatingReviews:e.compileTemplateStringReviews(e.config.starRatingReviewsTemplate,e.config.ratings),rating:e.config.ratings.average_rating,ratingMax:e.config.totalStars,useParenthesisOnProductCounter:e.config.useParenthesisOnProductCounter}}},getProducts:function(){var e=m(this.config.productClass);return this.config.productsLength=e.length,e},getProductIDs:function(){var a=this;m.when.apply(m,a.getProducts().map(function(e,t){var i=m(t),n=i.data(a.config.plpIdAttribute);n=(n=n||i.find(a.config.targetClass).data(a.config.id))&&n.toString(),i.data("ratings")&&n||(a.config.products.push({product:i,id:n}),i.data({ratings:{id:n}}),void 0!==n&&""!==n&&-1===a.config.productids.indexOf(n)&&a.config.productids.push(n))})).then(function(){a._fetch(a.getPowerReviewsEndpointURL(),!0)})},getTemplateString:function(e){return m(e).html()},compileTemplateStringRatings:function(e,t){return e.replace(/{{rating}}/g,t.average_rating).replace(/{{ratingMax}}/g,this.config.totalStars).replace(/{{reviews}}/g,t.review_count)},compileTemplateStringReviews:function(e,t){return e.replace(/{{reviews}}/g,t.review_count)},compileTemplateStringCustomerRecommended:function(e,t){return e.replace(/{{ratio}}/g,this.config.customerRecommendedRating)},getPowerReviewsConfig:function(){var e=this,t=m(e.config.powerReviewsClass).data(e.config.powerReviewsConfig);if(0,t){switch(e.config=m.extend(e.config,t),e.config.endpointService){case e.config.endpointServices.plpRatings:e.events(),e.checkEventTriggered();break;case e.config.endpointServices.sizeFit:e.subscribeSwatchEvents(),e._fetch(e.getPowerReviewsEndpointURL(),!1);break;case e.config.endpointServices.pdpRatings:case e.config.endpointServices.pdpReco:e._fetch(e.getPowerReviewsEndpointURL(),!1)}return t}return!1},getPowerReviewsEndpointURL:function(){var e=this,t=e.getTinyArray(e.config.productids,e.config.maxResults);e.pageIds=t||e.config.page_id;var i=e.config.merchantId,n=e.config.bypassConfig?e.config.bypassConfigParam:"",a=e.config.prLocale,o=e.config.apiBaseURL+"/m/"+i+"/l/"+a+"/product/"+e.pageIds+"/"+e.config.endpoint+"?apikey="+e.config.prAPIKey+"&"+n;return!!e.pageIds&&o},getTinyArray:function(e,t){var i=e.splice(0,t);return 0<i.length&&i},_fetch:function(e,t,i,n,a,o,r){if(0,e){var s=this,c=s.pageIds,g="boolean"!=typeof t||t,d="object"==typeof i?i:"",p="string"==typeof n?n:"GET",u="string"==typeof a?a:"json",f="boolean"==typeof o&&o,l="boolean"!=typeof r||r;return m.ajax({url:e,type:p,data:d,dataType:u,cache:f,crossDomain:l}).done(function(e){s.config.data=e,g&&s.config.endpointService===s.config.endpointServices.plpRatings&&s.populateProducts(s.config.data,c),s.config.endpointService===s.config.endpointServices.sizeFit&&s.populateSizeFit(),s.config.endpointService===s.config.endpointServices.pdpReco&&s.populateCustomerRecommended(),s.config.endpointService===s.config.endpointServices.pdpRatings&&s.populateSingleProduct(s.config.data,c)}).fail(function(e){s.unsubscribeEvents()})}},populateSingleProduct:function(e){this.results=e.results,this._build(m(this.config.productClass))},populateProducts:function(e,t){var c=this;c.results=e.results,m.when.apply(m,c.getProductRatings(t,c.results).map(function(s,e){var a=s.page_id.toString(),t=c.config.products.filter(function(e,t){var i=m(e.product),n=m.extend(i.data("ratings"),{index:t});if(i.data("ratings",n),e.id)return a===e.id.toString()});m.each(t,function(e,t){var i,n=m(t.product),a=m.extend(n.data("ratings"),s.rollup),o=n.find('script[type="application/ld+json"]');if(o&&0<o.length)try{i=JSON.parse(o.text())}catch(e){console.error(e)}if(i){i.aggregateRating||(i.aggregateRating={"@type":"AggregateRating",ratingValue:"0",reviewCount:"0",bestRating:"5",worstRating:"1"});var r=a.average_rating?a.average_rating.toString().replace(",","."):0;i.aggregateRating.ratingValue=r,i.aggregateRating.reviewCount=a.review_count.toString(),o.text(JSON.stringify(i))}n.data("ratings",a),c._build(n)})})).then(function(){c.fetchMoreProducts()})},populateSizeFit:function(){var i=this;var e=0<i.config.data.results.length&&i.config.data.results[0].rollup,t=i.getModelPlaque();0<m(".power-reviews-module > .pr-size-fit-reviews").length&&e&&0<e.review_count||t?(i.config.buildComplete||(i._build(m(i.config.targetClass)),i.config.buildComplete=!0),i.config.componentClassHidden&&(m(i.config.componentClass).show(),i.config.componentClassHidden=!1)):(i.config.componentClassHidden=!0,m(i.config.componentClass).hide()),i.config.waitForPubSub&&m.pubsub("subscribe","vfdp.wcs.product_reviews.loaded",function(e,t){m.pubsub("unsubscribe","vfdp.wcs.product_reviews.loaded"),setTimeout(function(){i.hideSizeAndFitModule()},i.config.eventDelay)})},hideSizeAndFitModule:function(){var e=this,t=e.getModelPlaque();e.getPRSizeSnippet()||t?!e.getPRSizeSnippet()&&t&&m(e.config.targetClass).hide():(m(e.config.componentClass).hide(),e.config.componentClassHidden=!0)},populateCustomerRecommended:function(){var i=this;var e=0<i.config.data.results.length&&i.config.data.results[0].rollup;e&&e.recommended_ratio>=i.config.customerRecommendedShowThreshold?(i.config.customerRecommendedRating=Math.ceil(100*e.recommended_ratio),i.config.waitForPubSub?m.pubsub("subscribe","vfdp.wcs.product_reviews.loaded",function(e,t){m.pubsub("unsubscribe","vfdp.wcs.product_reviews.loaded"),setTimeout(i._build(m(i.config.targetClass)),i.config.eventDelay),m(i.config.targetClass).addClass("customer-recommended")}):(i._build(m(i.config.targetClass)),m(i.config.targetClass).addClass("customer-recommended"))):m(i.element).remove()},getProductRatings:function(e,i){var n=this;return n.ratings=[],m.each(i,function(e,t){n.ratings.push(t.page_id)}),n.ratings.noratings=m.grep(e,function(e){return-1==m.inArray(e,n.ratings)}),m.each(n.ratings.noratings,function(e,t){i.push({page_id:t,rollup:{answered_questions:0,average_rating:0,review_count:0}})}),n.ratings=i,n.ratings},fetchMoreProducts:function(){var e=this;e.isMoreProductsToFetch()?e._fetch(e.getPowerReviewsEndpointURL(),!0):0<e.config.productids.length&&e._fetch(e.getPowerReviewsEndpointURL(),!0).done(function(){e.config.imagesLoadedTriggered=!1,e.config.products=[]})},isMoreProductsToFetch:function(){return this.config.productids.length>this.config.maxResults},setClipPath:function(e,n){var a=this;e.each(function(){var e=m(this),t=a.config.totalStarsWidth||a.getStarRatingWidth(e),i=e.find(a.config.topStarRatings);e.find(a.config.iconContainerClass).width(t),i.css({clip:"rect(-"+a.config.starHeight+"px,"+a.calculateStarRatingClipWidth(n,t)+"px,"+a.config.starHeight+"px, 0)"})})},getStarRatingWidth:function(e){var t=e.find(this.config.iconClass).eq(0),i=e.find(this.config.iconClass).eq(this.config.totalStars-1),n=t.position(),a=i.position(),o=Math.round(t.outerWidth()),r=Math.round(t.outerHeight()),s=0;return n&&a&&(s=Math.round(a.left)-Math.round(n.left)+o),this.config.starHeight=r,s},calculateStarRatingClipWidth:function(e,t){var i=e/this.config.totalStars;return Math.round(t*i)},checkEventTriggered:function(){var e=this;e.eventTimer=setTimeout(function(){e.getProductIDs()},e.config.eventDelay)},unsubscribeEvents:function(){m.pubsub("unsubscribe",this.productsLoadedEvent),m.pubsub("unsubscribe",this.loadMoreResultsEvent),m.pubsub("unsubscribe",this.imagesLoadedEvent)},getModelPlaque:function(){return this.currentSwatch||(this.currentSwatch=m(".color-swatches-js").find("button.selected")),m(this.currentSwatch).find("span").data("modelMeasurement")||m(this.currentSwatch).find(".color-swatch-button-content").data("modelMeasurement")},getPRSizeSnippet:function(){var e=m(this.config.prSnippetID).find(".p-w-r").html();return 0<(e?e.length:0)}}).defaults,n.prototype=m.extend({},t,n.prototype),m.fn[a]=function(t){return this.each(function(){var e=m(this).data(a);e||(e=new n(this,t).init(),m(this).data(a,e))})}});
//# sourceMappingURL=../../../maps/js/vfdp/ui/powerReviewsCustomAPI.hash-4f8096063e04a2cb0783cc26bf0615de.js.map