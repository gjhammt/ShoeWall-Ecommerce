define(["jquery","wcs.context","wcs.product-price-util","wcs.product-price-ajax"],function(u,c,p,i){var g={init:function(i){var e=this;return e.$productForm=i||u(".product-form-js"),g.$productForm=e.$productForm,g._isColorBundle=null,g._isProductBundle=null,g._bundlePartNumber=null,g._productId=[],g._attrId=[],g._itemPricingJSONCache=window.itemPrices||{},g._isBuyable=[],g._possibleProducts=[],g._isListenersSet=!1,g._isInitialized=!1,g._lastClickedElement=null,g._fetchQueue=[],g._fetchPointer=0,g._retryCount=[],g._firstLoad=WCS_CONFIG.get("PDP::ignoreSelectionOnFirstLoad"),g.DEFAULT_RETRY_COUNT=5,g.productCandidates=[],g.price=null,g.listPrice=null,g.lowPrice=null,g.highPrice=null,g.lowListPrice=null,g.highListPrice=null,g.lowPriceNumeric=0,g.highPriceNumeric=0,g.lowListPriceNumeric=0,g.highListPriceNumeric=0,g.metadata=this.$productForm.data("product-pricing-options"),g.productFormIndex=u(".product-form-js").index(this.$productForm),e.config=u.extend({},e.defaults,e.options,e.metadata),e._isColorBundle=e.$productForm.find(".selection-js [data-product-id]").length||0!==u(".context-trigger-js").length,e._bundlePartNumber=e.$productForm.data("bundle-part-number")||null,e._isProductBundle=e._multipleProductFormsPresent=1<u(".product-form-js").length,e},parseProductFormAttributes:function(){var t=this;return t.$productForm.each(function(i){var e=u(this),r=g._getProductPriceContainer(i);g._productId[i]=e.find("input[name=catEntryId]").val(),g._attrId[i]=e.find("input[name=attrName]").val(),g._possibleProducts[i]=[],g._isBuyable[i]=!0,g._retryCount[i]=t.DEFAULT_RETRY_COUNT,r.length&&g._handleItemPricing(i,g._productId[i])}),this},_getProductPriceContainer:function(i){return this._isProductBundle?u(".price-container-js").eq(i).find("> .product-price-js"):u("#product-info .product-price-js, .price-container-js .product-price-js").eq(i)},_getProductIdFromURLParameter:function(){return c.getParameterByName("productId")},_getPricingByProductID:function(e,r){g._initialPriceFetched?g._makeAnAjax(e,r):i.done(function(i){g._handleSuccessDataReturn(e,r,i),g._initialPriceFetched=!0}).fail(function(i){g._makeAnAjax(e,r)})},_makeAnAjax:function(i,e){var r=g.$productForm.data("priceUrl");if(void 0!==r&&e){var t=u.ajax({url:c.getURLWithContextRoot(r),data:{storeId:c.getStoreId(),langId:c.getLangId(),catalogId:c.getCatalogId(),productId:e}});g._handlePromise(t,i,e)}},_handlePromise:function(i,e,r){i.done(function(i){g._handleSuccessDataReturn(e,r,i)}).fail(function(){g._handleErrorReturn(e,r)})},_handleSuccessDataReturn:function(i,e,r){var t=this;""===r&&t._handleErrorReturn(i,e),t._itemPricingJSONCache[e]=r,t._handleItemPricing(i,e)},_handleErrorReturn:function(i,e){var r=this;if(0===r._retryCount[i])return!0;r._retryCount[i]--,r._getPricingByProductID(i,e)},_handleItemPricing:function(i,e){var r,t=this;t._itemPricingJSONCache.hasOwnProperty(e)?(r=t._itemPricingJSONCache[e],g._initialPriceFetched=!0,t._isInitialized=!0,void 0!==r.buyable&&(t._isBuyable[i]=r.buyable),!0===t._isBuyable[i]?t._resetPrice(i):t._showProductPrice(i,null),t._getProductIdFromURLParameter()&&t._resetPrice(i)):t._getPricingByProductID(i,e)},_getNewAttributeSelections:function(r){var t=g;t.$productForm.eq(r).find(".attr-box.selected:visible").each(function(){var i=u(this).data("attribute-value"),e=u(this).closest(".selection-js").data("attribute-id");WCS_CONFIG.get("PDP::pdpPriceUseColorCodeEnabled")&&(i=u(this).data("color-identifier")),void 0===e&&(e=t._attrId[r]),g.handleAttrInputChange(r,e,i,-1)}),t.$productForm.eq(r).find(".attr-input-js option:selected").each(function(){var i=u(this).data("attribute-value"),e=u(this).closest(".selection-js").data("attribute-id");void 0===e&&(e=t._attrId[r]),t.handleAttrInputChange(r,e,i,-1)})},_resetPrice:function(i){var e=g;e._possibleProducts[i]=[],!0===e._firstLoad?e._firstLoad=!1:e._getNewAttributeSelections(i),e._refreshProductPrice(i)},loadPriceValues:function(i,e){var r,t,c=new p(i),o=[],u=!1;if(null==e)c.updatePriceHTML(setToZero=!0,void 0),c.hideAllPrices();else{var n,d,s;if(e.lowPriceNumeric==e.highPriceNumeric?(n=e.lowPrice,o[0]=e.lowPriceNumeric):(WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&e.highPriceNumeric===e.highListPriceNumeric?(n=e.lowPrice+" <bdi>- "+e.highPrice+"</bdi>",u=!0):n=e.lowPrice+" - "+e.highPrice,o[0]=e.lowPriceNumeric,WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&e.highPriceNumeric!==e.highListPriceNumeric&&(o[1]=e.highPriceNumeric)),g.latestPrice=n,e.lowListPriceNumeric==e.highListPriceNumeric)d=e.lowPriceNumeric<=e.lowListPriceNumeric?e.lowListPrice:e.lowPrice,t=e.lowPriceNumeric<=e.lowListPriceNumeric?e.lowListPriceNumeric:e.lowPriceNumeric;else{var a=e.lowPriceNumeric<=e.lowListPriceNumeric?e.lowListPrice:e.lowPrice,P=e.highPriceNumeric<=e.highListPriceNumeric?e.highListPrice:e.highPrice;d=a!=P?a+" - "+P:a,WCS_CONFIG.get("PDP::pdpListPriceRangeEnabled")&&(t=[],e.highPriceNumeric<e.highListPriceNumeric?(t[0]=e.lowListPriceNumeric,t[1]=e.highListPriceNumeric):t[0]=e.lowListPriceNumeric)}if(s=e.lowPriceNumeric,c.setDataAmount(s),!0===WCS_CONFIG.get("grid::productShowDiscountPercentage"))if(n!=d){var l,h=r=0;-1<n.indexOf("-")&&(h=(r=n.split("-")[0].trim()).match(/\d+([\/.]\d+)?/g),h=parseFloat(h[0])),l=d.match(/\d+([\/.]\d+)?/g),(l=parseFloat(l[0]))<=h?c.updatePriceHTML(setToZero=!0,n):c.showSalePrice(d,n,o,t,u)}else n==d?c.updatePriceHTML(setToZero=!1,n):c.updatePriceHTML(setToZero=!0,void 0);else n!=d?(r=0,-1<n.indexOf("-")&&(r=n.split("-")[0].trim()),d<=r?c.updatePriceHTML(setToZero=!0,n):c.showSalePrice(d,n)):n==d?c.updatePriceHTML(setToZero=!1,n):c.updatePriceHTML(setToZero=!0,void 0)}},_showProductPrice:function(i,e){var r=g,t=r._getProductPriceContainer(i);if(r.loadPriceValues(t,e),!0===WCS_CONFIG.get("PDP::showPriceAboveAddToCart")){var c=u(".product-actions-product-price-container .product-price-js").eq(0);r.loadPriceValues(c,e)}},_refreshProductPrice:function(i){var e=g,r=e._productId;0===e._possibleProducts[i].length?void 0!==e._itemPricingJSONCache[e._productId[i]]&&e._showProductPrice(i,e._itemPricingJSONCache[r[i]].pricing.default):e._itemPricingJSONCache[r[i]].pricing?e.getNewProductPricingData(i):e._showProductPrice(i,null)},buildProductPriceJSONForRenderingPrice:function(i){var e=g,r=e._productId,t=!0;for(var c in e.productCandidates){var o=e.productCandidates[c],u=e._itemPricingJSONCache[r[i]].pricing.sku[o],n=u.price,d=u.priceNumeric,s=u.listPrice,a=u.listPriceNumeric;t?(t=!1,e.lowPrice=n,e.highPrice=n,e.lowListPrice=s,e.highListPrice=s,e.lowPriceNumeric=d,e.highPriceNumeric=d,e.lowListPriceNumeric=a,e.highListPriceNumeric=a):(d<e.lowPriceNumeric&&(e.lowPriceNumeric=d,e.lowPrice=n),d>e.highPriceNumeric&&(e.highPriceNumeric=d,e.highPrice=n),a<e.lowListPriceNumeric&&(e.lowListPriceNumeric=a,e.lowListPrice=s),a>e.highListPriceNumeric&&(e.highListPriceNumeric=a,e.highListPrice=s))}return{lowPrice:e.lowPrice,lowPriceNumeric:e.lowPriceNumeric,highPrice:e.highPrice,highPriceNumeric:e.highPriceNumeric,lowListPrice:e.lowListPrice,lowListPriceNumeric:e.lowListPriceNumeric,highListPrice:e.highListPrice,highListPriceNumeric:e.highListPriceNumeric}},getNewProductPricingData:function(i){var e=g;for(var r in e.productCandidates=e._possibleProducts[i][0].sku,e._possibleProducts[i])e.productCandidates=e.arrayIntersection(e.productCandidates,e._possibleProducts[i][r].sku);0<e.productCandidates.length?e._showProductPrice(i,g.buildProductPriceJSONForRenderingPrice(i)):e._showProductPrice(i,null)},arrayIntersection:function(i,e){var r=[];for(var t in i)-1<e.indexOf(i[t])&&r.push(i[t]);return r},handleAttrInputChange:function(i,e,r,t){var c=g;c._productId;if(void 0===r&&-1<t)0===t&&1===c._possibleProducts[i].length?c._possibleProducts[i]=[]:c._possibleProducts[i][t].sku=0===t?c._possibleProducts[i][1].sku:c._possibleProducts[i][0].sku;else if(void 0!==r){var o=[];void 0!==c._itemPricingJSONCache[c._productId[i]]&&(void 0===c._itemPricingJSONCache[c._productId[i]].pricing[e]?void 0!==c._itemPricingJSONCache[c._productId[i]].pricing.sku&&u.each(c._itemPricingJSONCache[c._productId[i]].pricing.sku,function(i,e){o.push(parseInt(i))}):void 0!==c._itemPricingJSONCache[c._productId[i]].pricing[e][r]&&(o=c._itemPricingJSONCache[c._productId[i]].pricing[e][r].sku),t<0?c._possibleProducts[i].push({attrId:e,sku:o}):c._possibleProducts[i][t].sku=o)}}};return g});
//# sourceMappingURL=../../../maps/js/wcs/view/product-price-service.hash-2a1f123df9616cb6cd6af09be0de6ff1.js.map